(function() {
    var tmp = $.fn.popover.Constructor.prototype.show;

    $.fn.popover.Constructor.prototype.show = function () {
        tmp.call(this);
        if (this.options.callback) {
            this.options.callback();
        }
    }

    var Cart = function(element, options) {
        this.$el = element;
        var $cart = this;

        this.$el.find('.info .rating').raty({
            starOff: "<%= asset_path("star-off.png") %>",
            starOn: "<%= asset_path("star-on.png") %>",
            starHalf: "<%= asset_path("star-half.png") %>",
            readOnly: true,
            size: 12,
            score: function() {
                return $(this).attr('data-score');
            }
        });

        this.$el.find('.pop-image').click(function(e) {
            e.preventDefault();
        });

        this.$el.find('.pop-image-top').popover({
            placement: 'top',
            container: 'body',
            trigger: 'hover'
        });

        this.$el.find('.pop-input').popover({
            html: true,
            placement: 'top',
            container: 'body',
            content: function() {
                return $(this).parent().find('.content-popover').html();
            },
            trigger: 'click',
            callback: popoverCallback
        });

        this.$el.find('.mark-as-moved').click(function(e) {
            var cartId = $cart.$el.attr('data-cart-id');

            $.getJSON('/carts/' + cartId + '/mark_as_moved', {moved: true},
                    function(data) {
                window.location.reload();
            });
        });

        this.$el.find('.info .photo').on('mouseenter', function(e) {
            $(this).parents('.info-header').find('.actions').addClass('show');
        });

        this.$el.find('.info .info-header').on('mouseleave', function(e) {
            $(this).find('.actions').removeClass('show');
        });

        this.$el.find('form').wheels_form();
        this.$el.find('.map-form').map_form();
        this.$el.find('.directions-modal').directions_modal();
    }

    $.fn.cart = function(options) {
        $.each(this, function(el) {
            var cart = new Cart($(this), options);
        });
    }

    $.fn.cart.Constructor = Cart;

    var controller;

    var init = function() {
        controller = $('.cart');
    }

    var popoverCallback = function() {
        $('.popover-input').keypress(function(e) {
            if(e.which === 13) {
                e.preventDefault();
                $(this).parent().submit();
                $(this).parents('.popover').hide();
            }
        });
    }

    var ready = function() {
        init();

        if (controller.length === 0) return;

        controller.cart();
    }

    $(document).ready(ready);
    $(document).on('page:load', ready);
})();
